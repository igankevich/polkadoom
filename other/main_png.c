void* png_compress(unsigned char *data, int data_len, int *out_len, int quality); 

#include "libs/miniz/miniz.h"

#define STBIW_ZLIB_COMPRESS png_compress
#define STB_IMAGE_WRITE_IMPLEMENTATION

#include "libs/stb/stb_image_write.h"

// https://github.com/nothings/stb/issues/113
void* png_compress(unsigned char *data, int data_len, int *out_len, int quality) {
    mz_ulong buflen = mz_compressBound(data_len);
    unsigned char* zlib = STBIW_MALLOC(buflen);
    int ret = mz_compress2(zlib, &buflen, data, data_len, 1);
    if (ret != MZ_OK) {
        return NULL;
    }
    *out_len = (int)buflen;
    return zlib;
}

#include <assert.h>
#include <stdio.h>
#include <malloc.h>
#include <stdint.h>

const uint32_t PALETTE[256] = {
	0x00010101, 0x0020180c, 0x00181008, 0x004c4c4c, 0x00ffffff, 0x001c1c1c, 0x00141414, 0x000c0c0c,
	0x00080808, 0x00303820, 0x00242c10, 0x00182008, 0x00101801, 0x00503c2c, 0x00483424, 0x00402c1c,
	0x00ffb7b7, 0x00f7abab, 0x00f3a3a3, 0x00eb9797, 0x00e78f8f, 0x00df8787, 0x00db7c7c, 0x00d37474,
	0x00cb6c6c, 0x00c76464, 0x00bf5c5c, 0x00bb5858, 0x00b35050, 0x00af4848, 0x00a74040, 0x00a33c3c,
	0x009b3434, 0x00973030, 0x008f2c2c, 0x008b2424, 0x00832020, 0x00801c1c, 0x00781818, 0x00741414,
	0x006c1010, 0x00680c0c, 0x00600808, 0x005c0808, 0x00540808, 0x00500101, 0x00480101, 0x00440101,
	0x00ffebdf, 0x00ffe3d3, 0x00ffdbc7, 0x00ffd3bb, 0x00ffcfb3, 0x00ffc7a7, 0x00ffbf9b, 0x00ffbb93,
	0x00ffb383, 0x00f7ab7c, 0x00efa374, 0x00e79b6c, 0x00df9364, 0x00d78b5c, 0x00cf8354, 0x00cb8050,
	0x00bf7c4c, 0x00b37448, 0x00ab7044, 0x00a36c40, 0x009b643c, 0x008f6038, 0x00875834, 0x00805430,
	0x0078502c, 0x006c4828, 0x00604424, 0x00544020, 0x004c381c, 0x00403018, 0x00342c14, 0x002c2410,
	0x00efefef, 0x00e7e7e7, 0x00dfdfdf, 0x00dbdbdb, 0x00d3d3d3, 0x00cbcbcb, 0x00c7c7c7, 0x00bfbfbf,
	0x00b7b7b7, 0x00b3b3b3, 0x00ababab, 0x00a7a7a7, 0x009f9f9f, 0x00979797, 0x00939393, 0x008b8b8b,
	0x00838383, 0x00808080, 0x00787878, 0x00707070, 0x006c6c6c, 0x00646464, 0x005c5c5c, 0x00585858,
	0x00505050, 0x00484848, 0x00444444, 0x003c3c3c, 0x00383838, 0x00303030, 0x00282828, 0x00242424,
	0x0078ff70, 0x0070ef68, 0x0068df60, 0x0060cf58, 0x005cbf50, 0x0054af48, 0x004c9f40, 0x00449338,
	0x00408330, 0x0038742c, 0x00306424, 0x0028541c, 0x00204418, 0x00183410, 0x0014240c, 0x000c1808,
	0x00bfa78f, 0x00b79f87, 0x00af9780, 0x00a78f78, 0x009f8770, 0x009b806c, 0x00937c64, 0x008b745c,
	0x00836c58, 0x007c6450, 0x0078604c, 0x00705844, 0x00685440, 0x00604c38, 0x00584434, 0x00544030,
	0x009f8364, 0x008f7854, 0x00836c4c, 0x00786040, 0x00685434, 0x005c482c, 0x00503c24, 0x0044341c,
	0x007c8064, 0x00707458, 0x00686c50, 0x005c6448, 0x0054583c, 0x00485034, 0x0040482c, 0x00384028,
	0x00ffff74, 0x00ebdb58, 0x00d7bb44, 0x00c39b30, 0x00af7c20, 0x009b5c14, 0x00874408, 0x00742c01,
	0x00ffffff, 0x00ffdbdb, 0x00ffbbbb, 0x00ff9b9b, 0x00ff7c7c, 0x00ff6060, 0x00ff4040, 0x00ff2020,
	0x00ff0101, 0x00ef0101, 0x00e30101, 0x00d70101, 0x00cb0101, 0x00bf0101, 0x00b30101, 0x00a70101,
	0x009b0101, 0x008b0101, 0x00800101, 0x00740101, 0x00680101, 0x005c0101, 0x00500101, 0x00440101,
	0x00e7e7ff, 0x00c7c7ff, 0x00ababff, 0x008f8fff, 0x007474ff, 0x005454ff, 0x003838ff, 0x001c1cff,
	0x000101ff, 0x000101e3, 0x000101cb, 0x000101b3, 0x0001019b, 0x00010183, 0x0001016c, 0x00010154,
	0x00ffffff, 0x00ffebdb, 0x00ffd7bb, 0x00ffc79b, 0x00ffb37c, 0x00ffa35c, 0x00ff8f3c, 0x00ff801c,
	0x00f37418, 0x00eb7010, 0x00df6810, 0x00d7600c, 0x00cb5808, 0x00c35001, 0x00b74801, 0x00af4401,
	0x00ffffff, 0x00ffffd7, 0x00ffffb3, 0x00ffff8f, 0x00ffff6c, 0x00ffff48, 0x00ffff24, 0x00ffff01,
	0x00a74001, 0x009f3801, 0x00933001, 0x00872401, 0x00503c28, 0x0044301c, 0x00382414, 0x00301c0c,
	0x00010154, 0x00010148, 0x0001013c, 0x00010130, 0x00010124, 0x00010118, 0x0001010c, 0x00010101,
	0x00ff9f44, 0x00ffe74c, 0x00ff7cff, 0x00ff01ff, 0x00cf01cf, 0x009f019b, 0x0070016c, 0x00a76c6c,
};

uint32_t doom_color_to_png_color(uint32_t doom_color) {
    uint32_t red = doom_color & 0xff;
    uint32_t green = (doom_color >> 8) & 0xff;
    uint32_t blue = (doom_color >> 16) & 0xff;
    return (red << 16) | (green << 8) | (blue << 0) | 0xff000000;
}

int main() {
    const int width = 320;
    const int height = 200;
    const int frame_len = width*height;
    uint8_t* frame = malloc(frame_len);
    FILE* file = fopen("frame-0", "r");
    fread(frame, frame_len, 1, file);
    fclose(file);
    uint8_t* palette_rgb = malloc(256 * 3);
    for (int i=0; i<256; ++i) {
        uint32_t doom_color = PALETTE[i];
        uint32_t blue = doom_color & 0xff;
        uint32_t green = (doom_color >> 8) & 0xff;
        uint32_t red = (doom_color >> 16) & 0xff;
        palette_rgb[3*i + 0] = red;
        palette_rgb[3*i + 1] = green;
        palette_rgb[3*i + 2] = blue;
    }
    int ret = stbi_write_png("test.png", width, height, 1, frame, 0, palette_rgb, 256*3);
    if (ret != 1) {
        fprintf(stderr, "Failed to write PNG.\n");
        return 1;
    }
    free(frame);
    free(palette_rgb);
    return 0;
}
